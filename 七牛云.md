# 七牛云对象存储集成完整文档

## 概述

本项目已集成七牛云对象存储服务，支持文件上传、头像上传等功能。七牛云提供了稳定、高效的对象存储服务，支持图片、文档等多种文件类型的存储和访问。

## 已完成的功能

### 1. 依赖配置
- ✅ 添加了七牛云Java SDK依赖 (`qiniu-java-sdk:7.7.0`)
- ✅ 添加了Gson依赖用于JSON处理

### 2. 配置类
- ✅ `QiniuProperties.java` - 七牛云配置属性类
- ✅ 在 `application.yml` 中添加了七牛云配置项

### 3. 服务层
- ✅ `QiniuService.java` - 七牛云文件上传服务
    - 支持单文件上传
    - 支持字节数组上传
    - 支持获取上传凭证
    - 自动生成唯一文件名
    - 完整的错误处理

### 4. 控制器层
- ✅ `FileController.java` - 文件上传控制器
    - `POST /api/file/upload` - 上传文件
    - `POST /api/file/upload/avatar` - 上传头像
    - `POST /api/file/upload/batch` - 批量上传文件
    - `GET /api/file/upload-token` - 获取上传凭证

### 5. 数据模型
- ✅ `FileUploadVo.java` - 文件上传返回信息VO类

### 6. 权限控制
- ✅ 所有文件上传接口都需要登录权限
- ✅ 头像上传增加了文件类型和大小验证

## 配置说明

### 1. 七牛云账号配置

在使用前，您需要：

1. **注册七牛云账号**：访问 [七牛云官网](https://www.qiniu.com/) 注册账号
2. **创建存储空间**：在控制台创建一个新的存储空间（Bucket），设置为公开空间
3. **获取配置信息**：
    - AccessKey：访问密钥
    - SecretKey：私有密钥
    - 存储空间名称（Bucket Name）
    - 域名（Domain）

### 2. 项目配置

在 `application.yml` 中配置七牛云参数：

```yaml
# 七牛云配置
oss:
  qiniu:
    domain: https://your-domain.com  # 替换为您的七牛云域名
    accessKey: your_access_key       # 替换为您的AccessKey
    secretKey: your_secret_key       # 替换为您的SecretKey
    bucketName: your_bucket_name     # 替换为您的存储空间名称
```

## 功能特性

### 1. 文件上传
- 支持单文件上传
- 支持批量文件上传
- 自动生成唯一文件名
- 返回完整的文件访问URL

### 2. 头像上传
- 专门用于头像上传
- 文件类型验证（仅支持图片）
- 文件大小限制（5MB）
- 返回头像访问URL

### 3. 上传凭证
- 获取七牛云上传凭证
- 支持前端直传功能

## 核心特性

### 1. 安全性
- 文件类型验证（头像上传）
- 文件大小限制（5MB）
- 权限控制（需要登录）
- 唯一文件名生成

### 2. 易用性
- 简单的API接口
- 详细的错误信息
- 完整的返回数据
- 支持批量上传

### 3. 性能优化
- 自动区域选择
- 异步上传处理
- 内置重试机制

## API接口

### 1. 上传文件

**接口地址**：`POST /api/file/upload`

**请求参数**：
- `file`：要上传的文件（MultipartFile）

**返回示例**：
```json
{
  "code": 0,
  "data": {
    "fileUrl": "https://your-domain.com/abc123.jpg",
    "fileName": "avatar.jpg",
    "fileSize": 102400,
    "fileType": "image/jpeg",
    "uploadTime": "2024-01-01T12:00:00.000Z"
  },
  "message": "文件上传成功"
}
```

### 2. 上传头像

**接口地址**：`POST /api/file/upload/avatar`

**请求参数**：
- `file`：头像文件（MultipartFile，仅支持图片格式）

**限制条件**：
- 文件类型：仅支持图片格式（image/*）
- 文件大小：不超过5MB

**返回示例**：
```json
{
  "code": 0,
  "data": {
    "fileUrl": "https://your-domain.com/avatar123.jpg",
    "fileName": "avatar.jpg",
    "fileSize": 51200,
    "fileType": "image/jpeg",
    "uploadTime": "2024-01-01T12:00:00.000Z"
  },
  "message": "头像上传成功"
}
```

### 3. 批量上传文件

**接口地址**：`POST /api/file/upload/batch`

**请求参数**：
- `files`：文件数组（MultipartFile[]）

**返回示例**：
```json
{
  "code": 0,
  "data": {
    "file1.jpg": "https://your-domain.com/abc123.jpg",
    "file2.png": "https://your-domain.com/def456.png"
  },
  "message": "批量上传成功"
}
```

### 4. 获取上传凭证

**接口地址**：`GET /api/file/upload-token`

**返回示例**：
```json
{
  "code": 0,
  "data": "eyJ0b2tlbiI6ImFiYzEyMyJ9",
  "message": "获取上传凭证成功"
}
```

## API接口列表

| 接口 | 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|------|
| 上传文件 | POST | `/api/file/upload` | 登录 | 上传单个文件 |
| 上传头像 | POST | `/api/file/upload/avatar` | 登录 | 上传头像（仅图片） |
| 批量上传 | POST | `/api/file/upload/batch` | 登录 | 批量上传多个文件 |
| 获取凭证 | GET | `/api/file/upload-token` | 登录 | 获取上传凭证 |

## 使用步骤

### 1. 配置七牛云
1. 注册七牛云账号
2. 创建存储空间（Bucket）
3. 获取AccessKey、SecretKey、域名等信息
4. 在 `application.yml` 中配置这些信息

### 2. 启动应用
```bash
mvn spring-boot:run
```

### 3. 测试接口
- 访问 Swagger UI: `http://localhost:8080/api/swagger-ui.html`
- 查看文件上传相关接口
- 使用Postman或其他工具测试上传功能

## 使用示例

### 1. 前端上传文件

```javascript
// 使用FormData上传文件
const formData = new FormData();
formData.append('file', fileInput.files[0]);

fetch('/api/file/upload', {
  method: 'POST',
  body: formData,
  headers: {
    'Authorization': 'Bearer ' + token
  }
})
.then(response => response.json())
.then(data => {
  console.log('文件上传成功:', data.data.fileUrl);
});
```

### 2. 前端直传（使用上传凭证）

```javascript
// 1. 获取上传凭证
fetch('/api/file/upload-token', {
  headers: {
    'Authorization': 'Bearer ' + token
  }
})
.then(response => response.json())
.then(data => {
  const uploadToken = data.data;
  
  // 2. 使用凭证直接上传到七牛云
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  formData.append('token', uploadToken);
  
  fetch('https://upload.qiniup.com', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    console.log('直传成功:', result.key);
  });
});
```

## 权限控制

所有文件上传接口都需要用户登录（`@Auth(Auth.AuthType.LOGIN)`），确保只有已登录用户才能上传文件。

## 错误处理

### 常见错误

1. **文件为空**：`文件不能为空`
2. **文件类型错误**：`只能上传图片文件`（头像上传时）
3. **文件大小超限**：`文件大小不能超过5MB`（头像上传时）
4. **上传失败**：`文件上传失败`
5. **配置错误**：`七牛云配置错误`

### 错误响应格式

```json
{
  "code": 400,
  "data": null,
  "message": "文件类型错误",
  "description": "只能上传图片文件"
}
```

## 返回数据格式

### 成功响应
```json
{
  "code": 0,
  "data": {
    "fileUrl": "https://your-domain.com/abc123.jpg",
    "fileName": "avatar.jpg",
    "fileSize": 102400,
    "fileType": "image/jpeg",
    "uploadTime": "2024-01-01T12:00:00.000Z"
  },
  "message": "文件上传成功"
}
```

### 错误响应
```json
{
  "code": 400,
  "data": null,
  "message": "文件类型错误",
  "description": "只能上传图片文件"
}
```

## 安全考虑

1. **文件类型验证**：头像上传时验证文件类型
2. **文件大小限制**：防止上传过大文件
3. **权限控制**：只有登录用户才能上传
4. **唯一文件名**：使用UUID生成唯一文件名，避免文件名冲突

## 性能优化

1. **自动区域选择**：使用 `Region.autoRegion()` 自动选择最佳上传区域
2. **异步处理**：文件上传为异步操作，不阻塞主线程
3. **错误重试**：七牛云SDK内置重试机制

## 扩展功能

### 1. 图片处理

七牛云支持图片处理功能，可以在URL后添加参数：

```
原图：https://your-domain.com/image.jpg
缩略图：https://your-domain.com/image.jpg?imageView2/2/w/200/h/200
```

### 2. 文件删除

可以扩展文件删除功能，通过七牛云SDK删除已上传的文件。

### 3. 文件列表

可以扩展获取文件列表功能，查看存储空间中的文件。

## 注意事项

1. **配置安全**：请妥善保管AccessKey和SecretKey，不要提交到代码仓库
2. **域名配置**：确保配置的域名正确，否则无法访问上传的文件
3. **存储空间权限**：建议设置为公开空间，便于直接访问文件
4. **费用控制**：注意七牛云的存储和流量费用，及时清理不需要的文件

## 扩展建议

1. **图片处理**：可以添加图片压缩、裁剪等功能
2. **文件管理**：可以添加文件删除、列表查询等功能
3. **CDN加速**：可以配置CDN域名提升访问速度
4. **防盗链**：可以配置防盗链保护文件安全

## 相关文档

- [七牛云官方文档](https://developer.qiniu.com/)
- [七牛云Java SDK文档](https://developer.qiniu.com/kodo/1239/java)

## 项目文件结构

```
src/main/java/com/ph/backuser/
├── config/
│   └── QiniuProperties.java          # 七牛云配置类
├── service/
│   └── QiniuService.java             # 七牛云服务类
├── controller/
│   └── FileController.java           # 文件上传控制器
└── model/vo/
    └── FileUploadVo.java             # 文件上传返回VO类
```

## 配置示例

### application.yml 配置
```yaml
# 七牛云配置
oss:
  qiniu:
    domain: http://xinqu.puxiaoshuai.top
    accessKey: Yx1N9U7GIakvGb99WaRmSJrXZiOstlJEIqnwyXjP
    secretKey: 8CT3x2But9ypV53CadGwb6XJswDux8fyZ9JXZBDw
    bucketName: scxinqu
```

### pom.xml 依赖
```xml
<!-- 七牛云对象存储SDK -->
<dependency>
    <groupId>com.qiniu</groupId>
    <artifactId>qiniu-java-sdk</artifactId>
    <version>7.7.0</version>
</dependency>

<!-- Gson for JSON处理 -->
<dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
    <version>2.8.6</version>
</dependency>
```